{{define "pages/files"}}
<div x-data="filesPage()" class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-dark-text mb-2">
                    üè• Salud del Almacenamiento
                </h1>
                <p class="text-dark-muted">
                    Detecta y resuelve problemas en tus archivos de media
                </p>
            </div>

            <!-- Sync Button -->
            <div class="flex items-center gap-4">
                <div x-show="lastSync" class="text-sm text-dark-muted">
                    √öltima sincronizaci√≥n: <span x-text="formatLastSync(lastSync)" class="text-blue-400"></span>
                </div>

                <div x-show="syncMessage" x-transition :class="{
                        'bg-green-50 border-green-200 text-green-800': syncMessageType === 'success',
                        'bg-red-50 border-red-200 text-red-800': syncMessageType === 'error',
                        'bg-blue-50 border-blue-200 text-blue-800': syncMessageType === 'info'
                    }" class="px-4 py-2 rounded-lg border text-sm max-w-md">
                    <p x-text="syncMessage" class="line-clamp-2"></p>
                </div>

                <button @click="syncFiles()" :disabled="syncing"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 whitespace-nowrap">
                    <svg x-show="!syncing" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                    <svg x-show="syncing" class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span x-text="syncing ? 'Sincronizando...' : 'Sincronizar'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Health Statistics Cards (usando componentes reutilizables) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <!-- Archivos Saludables -->
        <div x-data="healthCard('ok', healthyFiles.length, 'ok', () => selectedTab = 'healthy')"
            @click="filterByStatus()"
            :class="bgColorClasses"
            class="rounded-lg shadow-lg p-4 cursor-pointer transition-all border">
            <div class="flex items-center justify-between mb-2">
                <span class="text-3xl" x-text="icon"></span>
                <span class="text-2xl font-bold text-dark-text" x-text="count"></span>
            </div>
            <h3 class="text-sm font-semibold text-dark-text mb-1" x-text="title"></h3>
            <p class="text-xs text-dark-muted" x-text="description"></p>
        </div>

        <!-- Hu√©rfanos en Descargas -->
        <div x-data="healthCard('orphan_download', orphanDownloads.length, 'warning', () => selectedTab = 'attention')"
            @click="filterByStatus()"
            :class="bgColorClasses"
            class="rounded-lg shadow-lg p-4 cursor-pointer transition-all border">
            <div class="flex items-center justify-between mb-2">
                <span class="text-3xl" x-text="icon"></span>
                <span class="text-2xl font-bold text-dark-text" x-text="count"></span>
            </div>
            <h3 class="text-sm font-semibold text-dark-text mb-1" x-text="title"></h3>
            <p class="text-xs text-dark-muted" x-text="description"></p>
        </div>

        <!-- Solo Hardlinks -->
        <div x-data="healthCard('only_hardlink', hardlinkFiles.length, 'info', () => selectedTab = 'hardlinks')"
            @click="filterByStatus()"
            :class="bgColorClasses"
            class="rounded-lg shadow-lg p-4 cursor-pointer transition-all border">
            <div class="flex items-center justify-between mb-2">
                <span class="text-3xl" x-text="icon"></span>
                <span class="text-2xl font-bold text-dark-text" x-text="count"></span>
            </div>
            <h3 class="text-sm font-semibold text-dark-text mb-1" x-text="title"></h3>
            <p class="text-xs text-dark-muted" x-text="description"></p>
        </div>

        <!-- Torrents Muertos -->
        <div x-data="healthCard('not_seeding', deadTorrents.length, 'critical', () => selectedTab = 'critical')"
            @click="filterByStatus()"
            :class="bgColorClasses"
            class="rounded-lg shadow-lg p-4 cursor-pointer transition-all border">
            <div class="flex items-center justify-between mb-2">
                <span class="text-3xl" x-text="icon"></span>
                <span class="text-2xl font-bold text-dark-text" x-text="count"></span>
            </div>
            <h3 class="text-sm font-semibold text-dark-text mb-1">Torrents Muertos</h3>
            <p class="text-xs text-dark-muted">Sin seeds activos</p>
        </div>

        <!-- Sin Reproducir -->
        <div x-data="healthCard('missing_metadata', unwatchedFiles.length, 'warning', () => selectedTab = 'unwatched')"
            @click="filterByStatus()"
            :class="bgColorClasses"
            class="rounded-lg shadow-lg p-4 cursor-pointer transition-all border">
            <div class="flex items-center justify-between mb-2">
                <span class="text-3xl" x-text="icon"></span>
                <span class="text-2xl font-bold text-dark-text" x-text="count"></span>
            </div>
            <h3 class="text-sm font-semibold text-dark-text mb-1">Sin Reproducir</h3>
            <p class="text-xs text-dark-muted">Nunca vistos en Jellyfin</p>
        </div>
    </div>

    <!-- Filtros Avanzados (usando componente healthFilters) -->
    <div x-data="{ filtersOpen: false, filters: healthFilters() }" 
        @filters-changed="applyHealthFilters($event.detail)"
        class="mb-6">
        
        <button @click="filtersOpen = !filtersOpen"
            class="flex items-center gap-2 px-4 py-2 bg-dark-surface border border-dark-border rounded-lg hover:bg-slate-700/50 transition-colors">
            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-90': filtersOpen }" 
                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <span class="text-dark-text font-medium">Filtros Avanzados</span>
            <span x-show="filters.hasActiveFilters" 
                class="px-2 py-0.5 bg-blue-900/40 border border-blue-600/50 text-blue-300 rounded text-xs">
                <span x-text="filters.activeFilterCount"></span> activo<span x-text="filters.activeFilterCount > 1 ? 's' : ''"></span>
            </span>
        </button>
        
        <div x-show="filtersOpen" 
            x-transition
            class="mt-2 bg-dark-surface border border-dark-border rounded-lg p-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-dark-text mb-2">Tipo de Problema</label>
                    <select x-model="filters.selectedProblem" @change="filters.applyFilters()"
                        class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-dark-text">
                        <template x-for="option in filters.problemOptions">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-dark-text mb-2">Servicio</label>
                    <select x-model="filters.selectedService" @change="filters.applyFilters()"
                        class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-dark-text">
                        <template x-for="option in filters.serviceOptions">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-dark-text mb-2">Tama√±o</label>
                    <select x-model="filters.selectedSize" @change="filters.applyFilters()"
                        class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-dark-text">
                        <template x-for="option in filters.sizeOptions">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-dark-text mb-2">Antig√ºedad</label>
                    <select x-model="filters.selectedAge" @change="filters.applyFilters()"
                        class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-dark-text">
                        <template x-for="option in filters.ageOptions">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <input type="text" x-model="filters.searchQuery" @input="filters.applyFilters()" 
                    placeholder="Buscar por t√≠tulo o ruta..."
                    class="flex-1 px-4 py-2 bg-dark-bg border border-dark-border rounded-lg text-dark-text">
                
                <button @click="filters.clearFilters()"
                    :class="filters.hasActiveFilters ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-800 cursor-not-allowed opacity-50'"
                    class="px-4 py-2 text-white rounded-lg transition-colors">
                    Limpiar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs por Severidad -->
    <div class="bg-dark-surface border border-dark-border rounded-lg shadow-lg mb-6">
        <div class="border-b border-dark-border">
            <nav class="flex -mb-px overflow-x-auto">
                <button @click="selectedTab = 'healthy'"
                    :class="selectedTab === 'healthy' ? 'border-green-500 text-green-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                    class="px-6 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    üü¢ OK (<span x-text="healthyFiles.length">0</span>)
                </button>
                <button @click="selectedTab = 'attention'"
                    :class="selectedTab === 'attention' ? 'border-yellow-500 text-yellow-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                    class="px-6 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    üü° Atenci√≥n (<span x-text="orphanDownloads.length">0</span>)
                </button>
                <button @click="selectedTab = 'critical'"
                    :class="selectedTab === 'critical' ? 'border-red-500 text-red-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                    class="px-6 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    üî¥ Cr√≠ticos (<span x-text="deadTorrents.length">0</span>)
                </button>
                <button @click="selectedTab = 'hardlinks'"
                    :class="selectedTab === 'hardlinks' ? 'border-blue-500 text-blue-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                    class="px-6 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    üîó Hardlinks (<span x-text="hardlinkFiles.length">0</span>)
                </button>
                <button @click="selectedTab = 'unwatched'"
                    :class="selectedTab === 'unwatched' ? 'border-purple-500 text-purple-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                    class="px-6 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    üëÅÔ∏è Sin Ver (<span x-text="unwatchedFiles.length">0</span>)
                </button>
            </nav>
        </div>
    </div>

    <!-- Lista de Archivos -->
    <div class="space-y-3">
        <template x-for="file in filteredFiles" :key="file.id || file.file_path">
            <div class="bg-dark-surface border border-dark-border rounded-lg shadow-lg p-6 hover:border-slate-600 transition-colors">
                
                <!-- Status Badge (usando healthStatusBadge) -->
                <div class="mb-3">
                    <span x-data="healthStatusBadge(getFileHealthStatus(file), getFileSeverity(file), 'md')" 
                        :class="[colorClasses, sizeClasses]"
                        class="inline-flex items-center gap-1 rounded border">
                        <span x-text="icon"></span>
                        <span x-text="label"></span>
                    </span>
                </div>
                
                <!-- T√≠tulo del Archivo -->
                <h3 class="text-lg font-semibold text-dark-text mb-2" x-text="file.title || file.file_path.split('/').pop()"></h3>
                
                <!-- Ruta (Colapsable) -->
                <div x-data="{ showPath: false }" class="mb-3">
                    <button @click="showPath = !showPath" class="flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300">
                        <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-90': showPath }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <span>üìÅ Ver ruta completa</span>
                    </button>
                    <div x-show="showPath" x-transition class="mt-2 p-3 bg-slate-800/50 border border-slate-600 rounded-lg">
                        <p class="text-xs font-mono text-slate-300 break-all" x-text="file.file_path"></p>
                    </div>
                </div>
                
                <!-- Tama√±o -->
                <div class="flex items-center gap-2 text-sm text-dark-muted mb-4">
                    <span>üíæ <span x-text="formatBytes(file.size)"></span></span>
                </div>
                
                <!-- Servicios (usando serviceStatusIndicator) -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 mb-4">
                    <div x-data="serviceStatusIndicator('qbittorrent', file.in_qbittorrent, { 
                        state: file.torrent_state, 
                        ratio: file.seed_ratio,
                        category: file.torrent_category,
                        tags: file.torrent_tags,
                        seeding: file.is_seeding
                    })" 
                    @mouseenter="showTooltip = true"
                    @mouseleave="showTooltip = false"
                    class="relative">
                        <span :class="colorClasses"
                            class="px-2 py-1 rounded border inline-flex items-center gap-1 text-xs cursor-help w-full justify-center">
                            <span x-text="icon"></span>
                            <span x-text="label"></span>
                        </span>
                        
                        <div x-show="showTooltip && hasDetails" 
                            class="absolute z-50 bg-slate-900 border border-indigo-500/50 text-slate-200 text-xs rounded-lg p-3 shadow-xl w-64 bottom-full mb-2 left-0"
                            style="display: none;">
                            <div class="font-semibold text-indigo-400 mb-2">üß≤ qBittorrent</div>
                            <div class="space-y-1">
                                <div x-show="details.state"><span class="text-indigo-400">Estado:</span> <span x-text="details.state"></span></div>
                                <div x-show="details.ratio !== undefined"><span class="text-indigo-400">Ratio:</span> <span x-text="details.ratio?.toFixed(2)"></span></div>
                                <div x-show="details.seeding" class="text-green-400">‚¨ÜÔ∏è Seedeando</div>
                            </div>
                        </div>
                    </div>
                    
                    <div x-data="serviceStatusIndicator('radarr', file.in_radarr, {})">
                        <span :class="colorClasses"
                            class="px-2 py-1 rounded border inline-flex items-center gap-1 text-xs w-full justify-center">
                            <span x-text="icon"></span>
                            <span x-text="label"></span>
                        </span>
                    </div>
                    
                    <div x-data="serviceStatusIndicator('sonarr', file.in_sonarr, {})">
                        <span :class="colorClasses"
                            class="px-2 py-1 rounded border inline-flex items-center gap-1 text-xs w-full justify-center">
                            <span x-text="icon"></span>
                            <span x-text="label"></span>
                        </span>
                    </div>
                    
                    <div x-data="serviceStatusIndicator('jellyfin', file.in_jellyfin, {})">
                        <span :class="colorClasses"
                            class="px-2 py-1 rounded border inline-flex items-center gap-1 text-xs w-full justify-center">
                            <span x-text="icon"></span>
                            <span x-text="label"></span>
                        </span>
                    </div>
                    
                    <div x-data="serviceStatusIndicator('jellyseerr', file.in_jellyseerr, {})">
                        <span :class="colorClasses"
                            class="px-2 py-1 rounded border inline-flex items-center gap-1 text-xs w-full justify-center">
                            <span x-text="icon"></span>
                            <span x-text="label"></span>
                        </span>
                    </div>
                    
                    <div x-data="serviceStatusIndicator('jellystat', file.in_jellystat, {})">
                        <span :class="colorClasses"
                            class="px-2 py-1 rounded border inline-flex items-center gap-1 text-xs w-full justify-center">
                            <span x-text="icon"></span>
                            <span x-text="label"></span>
                        </span>
                    </div>
                </div>
                
                <!-- Hardlinks Info -->
                <div x-show="file.is_hardlink" class="mb-4">
                    <div x-data="{ showLinks: false }" @mouseenter="showLinks = true" @mouseleave="showLinks = false" class="relative inline-block">
                        <span class="px-3 py-1.5 rounded-lg bg-green-900/30 border border-green-600/50 text-green-300 text-sm font-medium cursor-help inline-flex items-center gap-2">
                            üîó Hardlink
                            <span class="px-1.5 py-0.5 bg-green-700/50 rounded text-xs" x-text="(file.hardlink_paths || '').split('|').filter(p => p.trim()).length"></span>
                        </span>
                        
                        <div x-show="showLinks" class="absolute z-50 bg-slate-900 border-2 border-green-500/50 text-slate-200 text-xs rounded-lg p-4 shadow-2xl w-96 bottom-full mb-2 left-0" style="display: none;">
                            <div class="font-semibold text-green-400 mb-3 text-sm">üîó Rutas enlazadas:</div>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                <template x-for="(path, idx) in (file.hardlink_paths || '').split('|').filter(p => p.trim())">
                                    <div class="p-2 rounded font-mono break-all text-xs"
                                        :class="path === file.file_path ? 'bg-green-900/40 border border-green-600/50 text-green-300 font-semibold' : 'bg-slate-800/50 border border-slate-600 text-slate-400'"
                                        x-text="(path === file.file_path ? '‚ûú ' : '  ') + path"></div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Badges adicionales -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <span x-show="file.quality" class="px-2 py-1 rounded bg-emerald-900/40 border border-emerald-600/50 text-emerald-300 text-xs" x-text="file.quality"></span>
                    <span x-show="file.has_been_watched" class="px-2 py-1 rounded bg-green-900/40 border border-green-600/50 text-green-300 text-xs">‚úÖ Visto</span>
                    <span x-show="!file.has_been_watched && file.in_jellyfin" class="px-2 py-1 rounded bg-purple-900/40 border border-purple-600/50 text-purple-300 text-xs">üëÅÔ∏è Sin reproducir</span>
                </div>
                
                <!-- Sugerencia -->
                <div x-show="getFileSuggestion(file)" class="p-3 bg-blue-900/20 border border-blue-600/30 rounded-lg">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                        <div>
                            <p class="text-xs font-semibold text-blue-300 mb-1">üí° Sugerencia</p>
                            <p class="text-xs text-blue-200/90" x-text="getFileSuggestion(file)"></p>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div x-show="filteredFiles.length === 0" class="text-center py-16 px-4">
        <svg class="mx-auto h-16 w-16 text-dark-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
            </path>
        </svg>
        <h3 class="text-lg font-medium text-dark-text mb-2">No hay archivos en esta categor√≠a</h3>
        <p class="text-sm text-dark-muted mb-6">
            <span x-show="selectedTab === 'healthy'">No se encontraron archivos saludables.</span>
            <span x-show="selectedTab === 'attention'">No hay archivos que necesiten atenci√≥n.</span>
            <span x-show="selectedTab === 'critical'">No hay problemas cr√≠ticos. ¬°Todo bien!</span>
            <span x-show="selectedTab === 'hardlinks'">No hay archivos con hardlinks.</span>
            <span x-show="selectedTab === 'unwatched'">Todos los archivos han sido reproducidos.</span>
        </p>
        <button @click="syncFiles()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
            üîÑ Sincronizar archivos
        </button>
    </div>
</div>

<script>
function filesPage() {
    return {
        files: [],
        lastSync: '',
        selectedTab: 'healthy',
        syncing: false,
        syncMessage: '',
        syncMessageType: 'info',
        syncMessageTimeout: null,

        async init() {
            await this.loadFiles();
        },

        get healthyFiles() {
            return this.files.filter(f => f.in_jellyfin && (f.in_radarr || f.in_sonarr) && !this.hasProblems(f));
        },

        get orphanDownloads() {
            return this.files.filter(f => f.in_qbittorrent && !f.in_jellyfin && !f.in_radarr && !f.in_sonarr);
        },

        get hardlinkFiles() {
            return this.files.filter(f => f.is_hardlink);
        },

        get deadTorrents() {
            return this.files.filter(f => {
                if (!f.in_qbittorrent) return false;
                return f.torrent_state === 'error' || 
                       f.torrent_state === 'missingFiles' ||
                       (f.in_jellyfin && !f.is_seeding && (f.seed_ratio || 0) < 0.5);
            });
        },

        get unwatchedFiles() {
            return this.files.filter(f => f.in_jellyfin && !f.has_been_watched);
        },

        get filteredFiles() {
            if (this.selectedTab === 'healthy') return this.healthyFiles;
            if (this.selectedTab === 'attention') return this.orphanDownloads;
            if (this.selectedTab === 'critical') return this.deadTorrents;
            if (this.selectedTab === 'hardlinks') return this.hardlinkFiles;
            if (this.selectedTab === 'unwatched') return this.unwatchedFiles;
            return this.files;
        },

        getFileHealthStatus(file) {
            if (file.torrent_state === 'error') return 'critical';
            if (file.in_qbittorrent && !file.in_jellyfin) return 'orphan_download';
            if (file.is_hardlink) return 'only_hardlink';
            if (!file.has_been_watched && file.in_jellyfin) return 'missing_metadata';
            return 'ok';
        },

        getFileSeverity(file) {
            if (file.torrent_state === 'error' || file.torrent_state === 'missingFiles') return 'critical';
            if (file.in_qbittorrent && !file.in_jellyfin) return 'warning';
            if (!file.has_been_watched && file.in_jellyfin) return 'warning';
            return 'ok';
        },

        getFileSuggestion(file) {
            if (file.in_qbittorrent && !file.in_jellyfin && !file.in_radarr && !file.in_sonarr) {
                return 'Este archivo est√° en descargas pero no en biblioteca. Considera importarlo a Radarr/Sonarr.';
            }
            if (file.torrent_state === 'error') {
                return 'El torrent tiene errores. Verifica qBittorrent para m√°s detalles.';
            }
            if (file.in_qbittorrent && file.in_jellyfin && !file.is_seeding && (file.seed_ratio || 0) < 0.5) {
                return 'Torrent muerto. Si ya est√° en Jellyfin, puedes eliminarlo de qBittorrent de forma segura.';
            }
            if (file.in_jellyfin && !file.has_been_watched) {
                return 'Nunca reproducido. Si no te interesa, considera eliminarlo para liberar espacio.';
            }
            return '';
        },

        hasProblems(file) {
            return file.torrent_state === 'error' || 
                   file.torrent_state === 'missingFiles' ||
                   (file.in_qbittorrent && !file.in_jellyfin && !file.in_radarr && !file.in_sonarr);
        },

        applyHealthFilters(filterData) {
            console.log('Applying filters:', filterData);
        },

        async loadFiles() {
            try {
                const response = await fetch('/api/files');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                this.files = data.files || [];
                this.lastSync = data.last_sync || '';
            } catch (error) {
                console.error('Error loading files:', error);
                this.showSyncMessage('Error al cargar archivos: ' + error.message, 'error');
            }
        },

        async syncFiles() {
            this.syncing = true;
            this.showSyncMessage('Iniciando sincronizaci√≥n...', 'info');

            try {
                const response = await fetch('/api/files/sync', { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                this.showSyncMessage('Sincronizaci√≥n completada', 'success');
                await this.loadFiles();
            } catch (error) {
                console.error('Sync error:', error);
                this.showSyncMessage('Error en sincronizaci√≥n: ' + error.message, 'error');
            } finally {
                this.syncing = false;
            }
        },

        showSyncMessage(message, type) {
            this.syncMessage = message;
            this.syncMessageType = type;
            
            if (this.syncMessageTimeout) clearTimeout(this.syncMessageTimeout);
            
            this.syncMessageTimeout = setTimeout(() => {
                this.syncMessage = '';
            }, 5000);
        },

        formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        formatLastSync(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'hace un momento';
                if (diffMins < 60) return `hace ${diffMins} min`;
                
                const diffHours = Math.floor(diffMs / 3600000);
                if (diffHours < 24) return `hace ${diffHours}h`;
                
                return date.toLocaleString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } catch (e) {
                return timestamp;
            }
        }
    };
}

// Shared configuration objects for Alpine.js components
const HEALTH_STATUS_CONFIG = {
    'ok': { icon: '‚úÖ', title: 'Archivos Saludables', label: 'OK', description: 'Todo funcionando correctamente' },
    'orphan_download': { icon: 'üì•', title: 'Hu√©rfanos en Descargas', label: 'Hu√©rfano', description: 'En qBittorrent, no en biblioteca' },
    'only_hardlink': { icon: 'üîó', title: 'Solo Hardlinks', label: 'Hardlink', description: 'Vinculados a m√∫ltiples rutas' },
    'not_seeding': { icon: '‚ö†Ô∏è', title: 'Torrents Muertos', label: 'Torrent Muerto', description: 'Sin seeds activos' },
    'missing_metadata': { icon: 'üëÅÔ∏è', title: 'Sin Reproducir', label: 'Sin Ver', description: 'Nunca vistos en Jellyfin' },
    'critical': { icon: 'üî¥', title: 'Cr√≠tico', label: 'Cr√≠tico', description: 'Requiere atenci√≥n inmediata' }
};

const SEVERITY_COLORS = {
    card: {
        'ok': 'bg-green-900/20 border-green-600/50 hover:border-green-500',
        'info': 'bg-blue-900/20 border-blue-600/50 hover:border-blue-500',
        'warning': 'bg-yellow-900/20 border-yellow-600/50 hover:border-yellow-500',
        'critical': 'bg-red-900/20 border-red-600/50 hover:border-red-500'
    },
    badge: {
        'ok': 'bg-green-900/40 border-green-600/50 text-green-300',
        'info': 'bg-blue-900/40 border-blue-600/50 text-blue-300',
        'warning': 'bg-yellow-900/40 border-yellow-600/50 text-yellow-300',
        'critical': 'bg-red-900/40 border-red-600/50 text-red-300'
    },
    service: {
        'present': 'bg-green-900/40 border-green-600/50 text-green-300',
        'absent': 'bg-gray-900/40 border-gray-600/50 text-gray-500'
    }
};

const SERVICE_CONFIG = {
    'qbittorrent': { icon: 'üß≤', label: 'qBittorrent' },
    'radarr': { icon: 'üé¨', label: 'Radarr' },
    'sonarr': { icon: 'üì∫', label: 'Sonarr' },
    'jellyfin': { icon: 'üéûÔ∏è', label: 'Jellyfin' },
    'jellyseerr': { icon: 'üé´', label: 'Jellyseerr' },
    'jellystat': { icon: 'üìä', label: 'Jellystat' }
};

// Alpine.js component: Health Card
function healthCard(status, count, severity, onClick) {
    const config = HEALTH_STATUS_CONFIG[status] || HEALTH_STATUS_CONFIG['ok'];

    return {
        icon: config.icon,
        title: config.title,
        description: config.description,
        count: count,
        bgColorClasses: SEVERITY_COLORS.card[severity] || SEVERITY_COLORS.card['ok'],
        filterByStatus: onClick
    };
}

// Alpine.js component: Health Status Badge
function healthStatusBadge(status, severity, size = 'sm') {
    const sizeClasses = {
        'sm': 'px-2 py-0.5 text-xs',
        'md': 'px-3 py-1 text-sm',
        'lg': 'px-4 py-2 text-base'
    };

    const config = HEALTH_STATUS_CONFIG[status] || HEALTH_STATUS_CONFIG['ok'];

    return {
        icon: config.icon,
        label: config.label,
        colorClasses: SEVERITY_COLORS.badge[severity] || SEVERITY_COLORS.badge['ok'],
        sizeClasses: sizeClasses[size] || sizeClasses['sm']
    };
}

// Alpine.js component: Service Status Indicator
function serviceStatusIndicator(serviceName, isPresent, details = {}) {
    const config = SERVICE_CONFIG[serviceName] || { icon: '‚ùì', label: serviceName };

    return {
        icon: config.icon,
        label: config.label,
        colorClasses: isPresent ? SEVERITY_COLORS.service.present : SEVERITY_COLORS.service.absent,
        showTooltip: false,
        hasDetails: details && typeof details === "object" && !Array.isArray(details) && details !== null && Object.keys(details).length > 0,
        details: details
    };
}

// Alpine.js component: Health Filters
function healthFilters() {
    return {
        selectedProblem: 'all',
        selectedService: 'all',
        selectedSize: 'all',
        selectedAge: 'all',
        searchQuery: '',

        problemOptions: [
            { value: 'all', label: 'Todos los problemas' },
            { value: 'orphan_download', label: 'Hu√©rfanos en descargas' },
            { value: 'not_seeding', label: 'Torrents muertos' },
            { value: 'missing_metadata', label: 'Sin reproducir' },
            { value: 'only_hardlink', label: 'Solo hardlinks' }
        ],

        serviceOptions: [
            { value: 'all', label: 'Todos los servicios' },
            { value: 'qbittorrent', label: 'qBittorrent' },
            { value: 'radarr', label: 'Radarr' },
            { value: 'sonarr', label: 'Sonarr' },
            { value: 'jellyfin', label: 'Jellyfin' },
            { value: 'jellyseerr', label: 'Jellyseerr' },
            { value: 'jellystat', label: 'Jellystat' }
        ],

        sizeOptions: [
            { value: 'all', label: 'Todos los tama√±os' },
            { value: 'small', label: '< 1 GB' },
            { value: 'medium', label: '1-10 GB' },
            { value: 'large', label: '10-50 GB' },
            { value: 'xlarge', label: '> 50 GB' }
        ],

        ageOptions: [
            { value: 'all', label: 'Todas las fechas' },
            { value: 'recent', label: '< 7 d√≠as' },
            { value: 'month', label: '< 30 d√≠as' },
            { value: 'quarter', label: '< 90 d√≠as' },
            { value: 'old', label: '> 90 d√≠as' }
        ],

        get hasActiveFilters() {
            return this.selectedProblem !== 'all' ||
                   this.selectedService !== 'all' ||
                   this.selectedSize !== 'all' ||
                   this.selectedAge !== 'all' ||
                   this.searchQuery.trim() !== '';
        },

        get activeFilterCount() {
            let count = 0;
            if (this.selectedProblem !== 'all') count++;
            if (this.selectedService !== 'all') count++;
            if (this.selectedSize !== 'all') count++;
            if (this.selectedAge !== 'all') count++;
            if (this.searchQuery.trim() !== '') count++;
            return count;
        },

        applyFilters() {
            // Dispatch custom event with filter data
            window.dispatchEvent(new CustomEvent('filters-changed', {
                detail: {
                    problem: this.selectedProblem,
                    service: this.selectedService,
                    size: this.selectedSize,
                    age: this.selectedAge,
                    search: this.searchQuery
                }
            }));
        },

        clearFilters() {
            this.selectedProblem = 'all';
            this.selectedService = 'all';
            this.selectedSize = 'all';
            this.selectedAge = 'all';
            this.searchQuery = '';
            this.applyFilters();
        }
    };
}
</script>
{{end}}
