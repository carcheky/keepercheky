<div x-data="settings()" x-init="init()" class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-dark-text dark:text-dark-text">Settings</h1>
        <button @click="saveAll()" :disabled="saving"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <svg x-show="!saving" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                </path>
            </svg>
            <svg x-show="saving" class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span x-text="saving ? 'Saving...' : 'Save All'"></span>
        </button>
    </div>

    <!-- Tabs -->
    <div class="border-b border-dark-border">
        <nav class="-mb-px flex space-x-8">
            <template x-for="service in services" :key="service.id">
                <button @click="activeTab = service.id"
                    :class="activeTab === service.id ? 'border-blue-500 text-blue-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                    x-text="service.label">
                </button>
            </template>
            <button @click="activeTab = 'cleanup'"
                :class="activeTab === 'cleanup' ? 'border-blue-500 text-blue-400' : 'border-transparent text-dark-muted hover:text-dark-text hover:border-slate-600'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                Cleanup Rules
            </button>
        </nav>
    </div>

    <!-- Service Settings Panels (Dynamic) -->
    <template x-for="service in services" :key="service.id">
        <div x-show="activeTab === service.id" class="bg-dark-surface dark:bg-dark-surface shadow-lg rounded-lg border border-dark-border p-6">
            <!-- Service Header with Enable Toggle -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-dark-text" x-text="service.label + ' Configuration'"></h2>
                <div class="flex items-center gap-2">
                    <label class="flex items-center"
                        :class="envSources[service.id]?.enabled ? 'cursor-not-allowed opacity-70' : 'cursor-pointer'">
                        <input type="checkbox" x-model="config.services[service.id].enabled"
                            :disabled="envSources[service.id]?.enabled" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                        </div>
                        <span class="ml-3 text-sm font-medium text-dark-text">Enabled</span>
                    </label>
                    <span x-show="envSources[service.id]?.enabled" class="text-xs text-blue-400">(from .env)</span>
                </div>
            </div>

            <!-- Service Fields -->
            <div class="space-y-4">
                <template x-for="field in service.fields" :key="field.name">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-1">
                            <span x-text="field.label"></span>
                            <span x-show="envSources[service.id]?.[field.name]" class="text-xs text-blue-400">(from .env)</span>
                        </label>
                        <input 
                            :type="field.type || 'text'" 
                            x-model="config.services[service.id][field.name]"
                            :placeholder="field.placeholder"
                            :disabled="envSources[service.id]?.[field.name]"
                            :class="envSources[service.id]?.[field.name] ? 'bg-slate-800/50 cursor-not-allowed' : 'bg-dark-bg'"
                            class="w-full px-3 py-2 border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-dark-text">
                    </div>
                </template>

                <!-- Test Connection Button -->
                <button @click="testConnection(service.id)" :disabled="testing"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
                    <span x-text="testing ? 'Testing...' : 'Test Connection'"></span>
                </button>

                <!-- Connection Results -->
                <div x-show="connectionResults[service.id]" x-transition class="mt-4">
                    <!-- Error State -->
                    <div x-show="connectionResults[service.id] && !connectionResults[service.id].success"
                        class="p-4 bg-red-900/20 text-red-300 border border-red-700/50 rounded-lg">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                    clip-rule="evenodd" />
                            </svg>
                            <p x-text="connectionResults[service.id].message"></p>
                        </div>
                    </div>

                    <!-- Success State with System Info -->
                    <div x-show="connectionResults[service.id] && connectionResults[service.id].success"
                        class="p-4 bg-green-900/20 border border-green-700/50 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <p class="font-semibold text-green-300">âœ“ Connection Successful</p>
                        </div>

                        <!-- System Information (if available) -->
                        <div x-show="connectionResults[service.id].system_info" 
                            class="grid grid-cols-2 gap-3 mt-4 pt-3 border-t border-green-200">
                            <template x-for="field in getSystemInfoDisplay(service.id)" :key="field.key">
                                <div :class="field.span ? 'col-span-2' : ''">
                                    <p class="text-xs text-green-400 font-medium" x-text="field.label"></p>
                                    <p x-show="field.html" class="text-sm text-green-300" :class="field.mono ? 'font-mono break-all' : ''" 
                                        x-html="field.value"></p>
                                    <p x-show="!field.html" class="text-sm text-green-300" :class="field.mono ? 'font-mono break-all' : ''" 
                                        x-text="field.value"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Cleanup Rules Panel -->
    <div x-show="activeTab === 'cleanup'" class="bg-dark-surface dark:bg-dark-surface shadow-lg rounded-lg border border-dark-border p-6">
        <h2 class="text-xl font-semibold text-dark-text mb-6">Cleanup Rules Configuration</h2>

        <div class="space-y-6">
            <!-- Dry Run Mode -->
            <div class="flex items-center justify-between p-4 bg-yellow-900/20 rounded-lg border border-yellow-700/50">
                <div>
                    <h3 class="font-medium text-dark-text">Dry Run Mode</h3>
                    <p class="text-sm text-dark-muted">Preview deletions without actually removing files</p>
                </div>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" x-model="config.cleanup.dry_run" class="sr-only peer">
                    <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>

            <!-- Days to Keep -->
            <div>
                <label class="block text-sm font-medium text-dark-text mb-1">Days to Keep Media</label>
                <input type="number" x-model.number="config.cleanup.days_to_keep" min="1" max="365"
                    class="w-full px-3 py-2 border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-dark-bg text-dark-text">
                <p class="text-sm text-dark-muted mt-1">Media older than this will be marked for deletion</p>
            </div>

            <!-- Leaving Soon Days -->
            <div>
                <label class="block text-sm font-medium text-dark-text mb-1">Leaving Soon Warning (days)</label>
                <input type="number" x-model.number="config.cleanup.leaving_soon_days" min="1" max="30"
                    class="w-full px-3 py-2 border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-dark-bg text-dark-text">
                <p class="text-sm text-dark-muted mt-1">Create symlinks this many days before deletion</p>
            </div>

            <!-- Exclusion Tags -->
            <div>
                <label class="block text-sm font-medium text-dark-text mb-1">Exclusion Tags</label>
                <input type="text" x-model="config.cleanup.exclusion_tags" placeholder="keep, favorite, important"
                    class="w-full px-3 py-2 border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-dark-bg text-dark-text">
                <p class="text-sm text-dark-muted mt-1">Comma-separated list of tags that prevent deletion</p>
            </div>

            <!-- Delete Unmonitored -->
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-medium text-dark-text">Delete Unmonitored</h3>
                    <p class="text-sm text-dark-muted">Remove media not monitored in Radarr/Sonarr</p>
                </div>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" x-model="config.cleanup.delete_unmonitored" class="sr-only peer">
                    <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div x-show="message" x-transition :class="{
            'bg-green-900/20 border-green-700/50 text-green-300': messageType === 'success',
            'bg-red-900/20 border-red-700/50 text-red-300': messageType === 'error'
        }" class="p-4 rounded-lg border">
        <p x-text="message"></p>
    </div>
</div>

<script>
    // System Info Display Helper
    function systemInfoDisplay(systemInfo, fieldsDef) {
        return {
            systemInfo: systemInfo,
            fieldsDef: fieldsDef || [],
            
            get displayFields() {
                // Check if systemInfo is actually empty (not just falsy)
                if (!this.systemInfo || (typeof this.systemInfo === 'object' && Object.keys(this.systemInfo).length === 0)) {
                    return [];
                }
                
                // Auto-generate fields if no field definitions provided
                if (this.fieldsDef.length === 0) {
                    const fields = [];
                    for (const [key, value] of Object.entries(this.systemInfo)) {
                        fields.push({
                            key: key,
                            label: key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                            value: this.formatValue(key, value),
                            html: this.needsHtml(value),
                            mono: key.includes('id') || key.includes('path'),
                            span: key.includes('path') || key.includes('address')
                        });
                    }
                    return fields;
                }
                
                // Use defined fields
                return this.fieldsDef.map(field => ({
                    ...field,
                    value: this.formatValue(field.key, this.systemInfo[field.key]),
                    html: field.html || this.needsHtml(this.systemInfo[field.key])
                }));
            },
            
            needsHtml(value) {
                // Only booleans need HTML rendering for styled badges
                return typeof value === 'boolean';
            },
            
            formatValue(key, value) {
                if (value === null || value === undefined) return 'N/A';
                if (typeof value === 'boolean') {
                    // Return HTML for boolean values (styled badges)
                    return value ? 
                        '<span class="px-2 py-1 bg-green-900/30 border border-green-600/50 text-green-300 rounded text-xs">Yes</span>' :
                        '<span class="px-2 py-1 bg-gray-900/30 border border-gray-600/50 text-gray-300 rounded text-xs">No</span>';
                }
                // Return escaped plain text for all other values
                return this.escapeHtml(String(value));
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };
    }

    function settings() {
        return {
            activeTab: 'radarr',
            config: {
                services: {
                    radarr: { enabled: false, url: '', api_key: '' },
                    sonarr: { enabled: false, url: '', api_key: '' },
                    jellyfin: { enabled: false, url: '', api_key: '' },
                    jellyseerr: { enabled: false, url: '', api_key: '' },
                    jellystat: { enabled: false, url: '', api_key: '' },
                    qbittorrent: { enabled: false, url: '', username: '', password: '' }
                },
                cleanup: {
                    dry_run: true,
                    days_to_keep: 90,
                    leaving_soon_days: 7,
                    exclusion_tags: '',
                    delete_unmonitored: false
                }
            },
            connectionResults: {},
            envSources: {},
            testing: false,
            saving: false,
            message: '',
            messageType: 'success',

            // Service definitions with metadata
            services: [
                {
                    id: 'radarr',
                    label: 'Radarr',
                    fields: [
                        { name: 'url', label: 'URL', type: 'url', placeholder: 'http://localhost:7878' },
                        { name: 'api_key', label: 'API Key', type: 'password', placeholder: 'Enter Radarr API Key' }
                    ],
                    systemInfoFields: [
                        { key: 'version', label: 'Version' },
                        { key: 'branch', label: 'Branch' },
                        { key: 'os', label: 'Operating System' },
                        { key: 'os_version', label: 'OS Version' },
                        { key: 'runtime', label: 'Runtime' },
                        { key: 'runtime_version', label: 'Runtime Version' },
                        { key: 'sqlite_version', label: 'SQLite Version' },
                        { key: 'authentication', label: 'Authentication' },
                        { key: 'app_data', label: 'App Data Path', mono: true, span: true },
                        { key: 'build_time', label: 'Build Time', span: true }
                    ]
                },
                {
                    id: 'sonarr',
                    label: 'Sonarr',
                    fields: [
                        { name: 'url', label: 'URL', type: 'url', placeholder: 'http://localhost:8989' },
                        { name: 'api_key', label: 'API Key', type: 'password', placeholder: 'Enter Sonarr API Key' }
                    ],
                    systemInfoFields: [
                        { key: 'version', label: 'Version' },
                        { key: 'branch', label: 'Branch' },
                        { key: 'os', label: 'Operating System' },
                        { key: 'os_version', label: 'OS Version' },
                        { key: 'runtime', label: 'Runtime' },
                        { key: 'runtime_version', label: 'Runtime Version' },
                        { key: 'sqlite_version', label: 'SQLite Version' },
                        { key: 'authentication', label: 'Authentication' },
                        { key: 'app_data', label: 'App Data Path', mono: true, span: true },
                        { key: 'build_time', label: 'Build Time', span: true }
                    ]
                },
                {
                    id: 'jellyfin',
                    label: 'Jellyfin',
                    fields: [
                        { name: 'url', label: 'URL', type: 'url', placeholder: 'http://localhost:8096' },
                        { name: 'api_key', label: 'API Key', type: 'password', placeholder: 'Enter Jellyfin API Key' }
                    ],
                    systemInfoFields: [
                        { key: 'version', label: 'Version' },
                        { key: 'product_name', label: 'Product Name' },
                        { key: 'server_name', label: 'Server Name' },
                        { key: 'server_id', label: 'Server ID', mono: true },
                        { key: 'os', label: 'Operating System' },
                        { key: 'os_display_name', label: 'OS Display Name' },
                        { key: 'local_address', label: 'Local Address', mono: true, span: true }
                    ]
                },
                {
                    id: 'jellyseerr',
                    label: 'Jellyseerr',
                    fields: [
                        { name: 'url', label: 'URL', type: 'url', placeholder: 'http://localhost:5055' },
                        { name: 'api_key', label: 'API Key', type: 'password', placeholder: 'Enter Jellyseerr API Key' }
                    ],
                    systemInfoFields: [
                        { key: 'version', label: 'Version' },
                        { key: 'commit_tag', label: 'Commit Tag', mono: true },
                        { key: 'update_available', label: 'Update Available' },
                        { key: 'commits_behind', label: 'Commits Behind' }
                    ]
                },
                {
                    id: 'jellystat',
                    label: 'Jellystat',
                    fields: [
                        { name: 'url', label: 'URL', type: 'url', placeholder: 'http://localhost:3000' },
                        { name: 'api_key', label: 'API Key', type: 'password', placeholder: 'Enter Jellystat API Key' }
                    ],
                    systemInfoFields: [
                        { key: 'version', label: 'Version' }
                    ]
                },
                {
                    id: 'qbittorrent',
                    label: 'qBittorrent',
                    fields: [
                        { name: 'url', label: 'URL', type: 'url', placeholder: 'http://localhost:8080' },
                        { name: 'username', label: 'Username', type: 'text', placeholder: 'admin' },
                        { name: 'password', label: 'Password', type: 'password', placeholder: 'Enter qBittorrent Password' }
                    ],
                    systemInfoFields: [
                        { key: 'version', label: 'Version' },
                        { key: 'bitness', label: 'Architecture' },
                        { key: 'qt', label: 'Qt Version' },
                        { key: 'libtorrent', label: 'Libtorrent' },
                        { key: 'boost', label: 'Boost' },
                        { key: 'openssl', label: 'OpenSSL' }
                    ]
                }
            ],

            async init() {
                await this.loadConfig();
            },

            async loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    if (response.ok) {
                        const data = await response.json();
                        this.config = data;
                        // Store env_sources to disable fields that come from .env
                        if (data.env_sources) {
                            this.envSources = data.env_sources;
                        }
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            },

            async testConnection(service) {
                this.testing = true;
                this.connectionResults[service] = null;

                try {
                    const response = await fetch(`/api/config/test/${service}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.config.services[service])
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.connectionResults[service] = {
                            success: true,
                            message: data.message || 'Connection successful',
                            system_info: data.system_info || null
                        };
                    } else {
                        this.connectionResults[service] = {
                            success: false,
                            message: `âœ— Connection failed: ${data.error || 'Unknown error'}`
                        };
                    }
                } catch (error) {
                    this.connectionResults[service] = {
                        success: false,
                        message: `âœ— Error: ${error.message}`
                    };
                } finally {
                    this.testing = false;
                }
            },

            async saveAll() {
                this.saving = true;
                this.message = '';

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.config)
                    });

                    if (response.ok) {
                        this.showMessage('Configuration saved successfully!', 'success');
                    } else {
                        const data = await response.json();
                        this.showMessage(data.error || 'Failed to save configuration', 'error');
                    }
                } catch (error) {
                    this.showMessage('Error: ' + error.message, 'error');
                } finally {
                    this.saving = false;
                }
            },

            getSystemInfoDisplay(serviceId) {
                const service = this.services.find(s => s.id === serviceId);
                const systemInfo = this.connectionResults[serviceId]?.system_info;
                
                if (!systemInfo || !service) {
                    return [];
                }
                
                // Use the systemInfoDisplay helper to generate fields
                const helper = systemInfoDisplay(systemInfo, service.systemInfoFields || []);
                return helper.displayFields;
            },

            showMessage(msg, type = 'success') {
                this.message = msg;
                this.messageType = type;
                setTimeout(() => {
                    this.message = '';
                }, 5000);
            }
        }
    }
</script>
